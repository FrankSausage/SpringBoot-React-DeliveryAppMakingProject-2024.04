{"version":3,"file":"api_loader.js","sourceRoot":"","sources":["../../src/api_loader/api_loader.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright 2023 Google LLC\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport {html, PropertyValues} from 'lit';\nimport {customElement, property} from 'lit/decorators.js';\n\nimport {BaseComponent} from '../base/base_component.js';\nimport {ATTRIBUTION_SOURCE_ID, LIBRARY_VERSION} from '../base/constants.js';\nimport {LoggingController} from '../base/logging_controller.js';\nimport {Deferred} from '../utils/deferred.js';\n\nimport inlineScript from './inline_script.js';\n\n/** Returns a reference to `google.maps` from the global scope, if defined. */\nfunction getGoogleMaps(): typeof google.maps|undefined {\n  try {\n    return google?.maps;\n  } catch (e) {\n    return undefined;\n  }\n}\n\n/** Imports Web Components defined by the Maps JavaScript API. */\nfunction loadComponentsFromMapsJS(googleMaps: typeof google.maps) {\n  googleMaps.importLibrary('maps');\n  googleMaps.importLibrary('marker');\n}\n\n/** Returns a `LoggingController` owned by the element, if one exists. */\nfunction getLogger(host: HTMLElement): LoggingController|undefined {\n  const logger = (host as {logger?: unknown}).logger;\n  return logger instanceof LoggingController ? logger : undefined;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'gmpx-api-loader': APILoader;\n  }\n}\n\n/**\n * The API loader component loads the Google Maps Platform libraries necessary\n * for Extended Components.\n *\n * To use this component, make sure you [sign up for Google Maps Platform and\n * create an API\n * key](https://console.cloud.google.com/google/maps-apis/start).\n * By default, the API loader component will request the beta version of the\n * Maps JavaScript API, giving you access to additional components [`<gmp-map>`\n * and\n * `<gmp-advanced-marker>`](https://developers.google.com/maps/documentation/javascript/web-components/overview).\n * However, you can set the `version` attribute to select a stable (General\n * Availability) version of the SDK such as `weekly`.\n */\n@customElement('gmpx-api-loader')\nexport class APILoader extends BaseComponent {\n  /**\n   * An alias for the `key` property. React developers should use this prop to\n   * set the API key.\n   */\n  set apiKey(key: string|undefined) {\n    this.key = key;\n  }\n  get apiKey(): string|undefined {\n    return this.key;\n  }\n\n  /**\n   * Maps JS customers can configure HTTP Referrer Restrictions in the Cloud\n   * Console to limit which URLs are allowed to use a particular API Key. This\n   * parameter can limit the amount of data sent to Google Maps when evaluating\n   * HTTP Referrer Restrictions. Please see the\n   * [documentation](https://developers.google.com/maps/documentation/javascript/dynamic-loading#optional_parameters)\n   * for more information.\n   */\n  @property({attribute: 'auth-referrer-policy', reflect: true, type: String})\n  authReferrerPolicy?: string;\n\n  /**\n   * (Required) A valid Google Maps Platform API key. If you don't have one\n   * already [sign up for Google Maps Platform and create an API\n   * key](https://console.cloud.google.com/google/maps-apis/start).\n   *\n   * React developers are encouraged to use the `apiKey` property instead,\n   * as `key` is a reserved word.\n   *\n   * You can learn more about API keys in the Google Maps Platform\n   * [documentation](https://developers.google.com/maps/documentation/javascript/get-api-key).\n   */\n  @property({reflect: true, type: String}) key?: string;\n\n  /**\n   * The language code; defaults to the user's preferred language setting as\n   * specified in the browser when displaying textual information. Read [more on\n   * localization](https://developers.google.com/maps/documentation/javascript/localization).\n   */\n  @property({reflect: true, type: String}) language?: string;\n\n  /**\n   * The region code to use. This alters the map's behavior based on a given\n   * country or territory. Read [more on region\n   * codes](https://developers.google.com/maps/documentation/javascript/localization#Region).\n   */\n  @property({reflect: true, type: String}) region?: string;\n\n  /**\n   * To understand usage and ways to improve our solutions, Google includes the\n   * `solution_channel` query parameter in API calls to gather information about\n   * code usage. You may opt out at any time by setting this attribute to an\n   * empty string. Read more in the\n   * [documentation](https://developers.google.com/maps/reporting-and-monitoring/reporting#solutions-usage).\n   */\n  @property({attribute: 'solution-channel', reflect: true, type: String})\n  solutionChannel?: string;\n\n  /**\n   * The release channel or version numbers. See the\n   * [documentation](https://developers.google.com/maps/documentation/javascript/versions)\n   * for more information.\n   */\n  @property({reflect: true, type: String}) version = 'beta';\n\n  /** A deferred promise that resolves to the `google.maps` object. */\n  private static googleMapsDeferred = new Deferred<typeof google.maps>();\n\n  /** Whether the inline script has been invoked by this component. */\n  private static inlineScriptLoaded = false;\n\n  /** A single instance of this component used to detect duplicates. */\n  private static instance?: APILoader;\n\n  override async connectedCallback() {\n    super.connectedCallback();\n\n    if (APILoader.instance) {\n      this.logger.warn(\n          'Found multiple instances of this element on the same page. ' +\n              'The Google Maps JavaScript API can only be configured once; ' +\n              'please ensure you only have a single instance.',\n          this);\n    } else {\n      APILoader.instance = this;\n    }\n  }\n\n  protected override willUpdate(changedProperties: PropertyValues<this>) {\n    // Do not handle updates to any duplicate API loader elements.\n    if (APILoader.instance !== this) return;\n\n    this.tryLoadGoogleMapsAPI(changedProperties);\n  }\n\n  protected override render() {\n    return html`<slot></slot>`;\n  }\n\n  private getSolutionChannel(): string|undefined {\n    if (this.solutionChannel === '') return undefined;\n    if (!this.solutionChannel) {\n      return `GMP_${ATTRIBUTION_SOURCE_ID}_extended_v${LIBRARY_VERSION}`;\n    }\n    return this.solutionChannel;\n  }\n\n  private tryLoadGoogleMapsAPI(changedProperties: PropertyValues<this>) {\n    if (APILoader.googleMapsDeferred.value) {\n      if (APILoader.inlineScriptLoaded) {\n        const changedProperty = changedProperties.keys().next().value;\n        this.logger.warn(\n            `Property '${changedProperty}' cannot be updated once the ` +\n            'Google Maps JavaScript API is already loaded.');\n      } else {\n        this.logger.warn(\n            'Please remove the <gmpx-api-loader> element if you are using ' +\n            'the Google Maps JavaScript API inline bootstrap loader. ' +\n            'Duplicate configuration may cause unexpected behavior.');\n      }\n    } else if (this.key !== undefined) {\n      const {key, version, language, region, authReferrerPolicy} = this;\n      const solutionChannel = this.getSolutionChannel();\n      const googleMaps = inlineScript.load({\n        key,\n        ...(version && {v: version}),\n        ...(language && {language}),\n        ...(region && {region}),\n        ...(solutionChannel && {solutionChannel}),\n        ...(authReferrerPolicy && {authReferrerPolicy}),\n      });\n      APILoader.inlineScriptLoaded = true;\n      APILoader.googleMapsDeferred.resolve(googleMaps);\n      loadComponentsFromMapsJS(googleMaps);\n    }\n  }\n\n  /**\n   * Retrieves a reference to the specified Maps JavaScript API library.\n   *\n   * Libraries are [loaded dynamically from the Maps JavaScript\n   * API](https://developers.google.com/maps/documentation/javascript/dynamic-loading).\n   * If an instance of the API is not already available, one will be configured\n   * and loaded based on a `<gmpx-api-loader>` element in the document.\n   *\n   * @param library Name of the library. Full list of libraries can be found in\n   *     the\n   *     [documentation](https://developers.google.com/maps/documentation/javascript/libraries).\n   * @param consumer Optionally specify the custom element requesting the\n   *     library to provide more helpful console warnings when a library cannot\n   *     be loaded.\n   * @nocollapse\n   */\n  static async importLibrary(library: string, consumer?: HTMLElement):\n      Promise<google.maps.CoreLibrary|google.maps.MapsLibrary|\n              google.maps.PlacesLibrary|google.maps.GeocodingLibrary|\n              google.maps.RoutesLibrary|google.maps.MarkerLibrary|\n              google.maps.GeometryLibrary|google.maps.ElevationLibrary|\n              google.maps.StreetViewLibrary|\n              google.maps.JourneySharingLibrary|\n              google.maps.DrawingLibrary|google.maps.VisualizationLibrary> {\n    let googleMaps = APILoader.googleMapsDeferred.value;\n    if (!googleMaps) {\n      APILoader.pollForGoogleMaps(\n          /* numRetries= */ 5, /* interval= */ 1000,\n          consumer && getLogger(consumer));\n      googleMaps = await APILoader.googleMapsDeferred.promise;\n    }\n    return googleMaps.importLibrary(library);\n  }\n\n  /**\n   * Resets API loader state and removes `google.maps` from the global scope.\n   * This method should be invoked for testing purposes only.\n   * @ignore\n   */\n  static reset() {\n    delete (window as {google?: typeof google}).google;\n    delete APILoader.instance;\n    APILoader.inlineScriptLoaded = false;\n    APILoader.googleMapsDeferred = new Deferred<typeof google.maps>();\n  }\n\n  /** @nocollapse */\n  private static pollForGoogleMaps(\n      numRetries: number, interval: number, logger?: LoggingController,\n      pollCount = 0) {\n    const googleMaps = getGoogleMaps();\n    if (googleMaps) {\n      // Display a warning if `google.maps` is not present in the global\n      // namespace at first, but shows up during subsequent polling period.\n      // This indicates that the developer is using the legacy script loader.\n      if (!APILoader.inlineScriptLoaded && pollCount > 0) {\n        (logger ?? console)\n            .warn(\n                'Using the legacy Google Maps JavaScript API script loader ' +\n                'may result in suboptimal performance. ' +\n                'For best results, please include a <gmpx-api-loader> ' +\n                '(https://github.com/googlemaps/extended-component-library) ' +\n                'or use the inline bootstrap loader ' +\n                '(https://goo.gle/js-api-loading) instead.');\n      }\n      APILoader.googleMapsDeferred.resolve(googleMaps);\n      loadComponentsFromMapsJS(googleMaps);\n    } else if (numRetries > 0) {\n      window.setTimeout(() => {\n        APILoader.pollForGoogleMaps(\n            numRetries - 1, interval, logger, pollCount + 1);\n      }, interval);\n    } else {\n      // Throw an error if the Maps JavaScript API is not initialized after\n      // several polling attempts. This should help developers debug scenarios\n      // where they forgot to include an API loader or script tag.\n      let errorMessage = logger ?\n          logger.formatMessage(\n              'The Google Maps JavaScript API is required for this element ' +\n              'to function correctly. ') :\n          'APILoader.importLibrary(): ' +\n              'Unable to initialize the Google Maps JavaScript API. ';\n      errorMessage += 'Please ensure you have a <gmpx-api-loader> on the ' +\n          'page with a valid API key. ' +\n          'https://github.com/googlemaps/extended-component-library';\n      throw new Error(errorMessage);\n    }\n  }\n}\n"]}