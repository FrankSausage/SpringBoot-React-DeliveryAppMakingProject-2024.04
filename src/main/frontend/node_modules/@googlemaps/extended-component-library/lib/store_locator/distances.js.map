{"version":3,"file":"distances.js","sourceRoot":"","sources":["../../src/store_locator/distances.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright 2023 Google LLC\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport {APILoader} from '../api_loader/api_loader.js';\nimport {LatLng, LatLngLiteral} from '../utils/googlemaps_types.js';\nimport {RequestCache} from '../utils/request_cache.js';\n\nconst CACHE_SIZE = 10;\nconst MAX_DISTANCE_MATRIX_DESTINATIONS = 25;\n\nfunction makeDistanceMatrixRequestCache() {\n  return new RequestCache<\n      google.maps.DistanceMatrixRequest, google.maps.DistanceMatrixResponse,\n      google.maps.MapsRequestError>(\n      CACHE_SIZE, (error: google.maps.MapsRequestError) => {\n        // Requests with a transient error of OVER_QUERY_LIMIT\n        // and UNKNOWN_ERROR should be retried. See full list of statuses\n        // https://developers.google.com/maps/documentation/javascript/reference/distance-matrix#DistanceMatrixStatus\n        return error.code ===\n            'OVER_QUERY_LIMIT' as google.maps.DistanceMatrixStatus ||\n            error.code === 'UNKNOWN_ERROR' as google.maps.DistanceMatrixStatus;\n      });\n}\n\n/** How a distance was calculated. */\nexport enum DistanceSource {\n  GEOMETRIC,\n  DISTANCE_MATRIX\n}\n\n/** Distance measurement between two locations. */\nexport interface DistanceInfo {\n  value?: number;\n  text?: string;\n  source?: DistanceSource;\n}\n\ntype Destination = LatLng|LatLngLiteral;\n\n/**\n * A utility for calculating distances from a single point to N other points.\n *\n * This class combines the Maps JS Distance Matrix API with a global request\n * cache and a fallback for when N is more than allowed by the API.\n */\nexport class DistanceMeasurer {\n  private static service?: google.maps.DistanceMatrixService;\n  private static cache = makeDistanceMatrixRequestCache();\n\n  constructor(private readonly elementForLogging?: HTMLElement) {}\n\n  /**\n   * Computes travel distance between `origin` and each of the `destinations`.\n   *\n   * If there are more than 25 `destinations`, the Distance Matrix API cannot\n   * process them in a single request. In this case, the method will assign\n   * a geometric distance to all N `destinations`, then use Distance Matrix\n   * to compute accurate distances to the nearest 25 options.\n   */\n  async computeDistances(\n      origin: LatLng|LatLngLiteral, destinations: Array<LatLng|LatLngLiteral>,\n      units: google.maps.UnitSystem): Promise<DistanceInfo[]> {\n    const distances = new Map<Destination, DistanceInfo>();\n    for (const destination of destinations) {\n      distances.set(destination, {});\n    }\n\n    let destinationsForLookup = [...destinations];\n    if (destinations.length > MAX_DISTANCE_MATRIX_DESTINATIONS) {\n      // Too many `destinations` for Distance Matrix; start by calculating\n      // geometric distance.\n      const {spherical} =\n          await APILoader.importLibrary('geometry', this.elementForLogging) as\n          google.maps.GeometryLibrary;\n      for (const [destination, distanceInfo] of distances.entries()) {\n        distanceInfo.source = DistanceSource.GEOMETRIC;\n        distanceInfo.value =\n            spherical.computeDistanceBetween(origin, destination);\n      }\n\n      // Take the top 25 closest points to refine via Distance Matrix.\n      const getSphericalDistance = (p: Destination) =>\n          distances.get(p)?.value ?? Infinity;\n      destinationsForLookup.sort(\n          (a, b) => getSphericalDistance(a) - getSphericalDistance(b));\n      destinationsForLookup =\n          destinationsForLookup.slice(0, MAX_DISTANCE_MATRIX_DESTINATIONS);\n    }\n\n    const request: google.maps.DistanceMatrixRequest = {\n      origins: [origin],\n      destinations: destinationsForLookup,\n      travelMode: 'DRIVING' as google.maps.TravelMode,\n      unitSystem: units,\n    };\n    let responsePromise = DistanceMeasurer.cache.get(request);\n    if (responsePromise == null) {\n      responsePromise = this.getService().then(\n          (service) => service.getDistanceMatrix(request));\n      DistanceMeasurer.cache.set(request, responsePromise);\n    }\n    const response = await responsePromise;\n    for (let i = 0; i < response.rows[0].elements.length; i++) {\n      const distanceInfo = distances.get(destinationsForLookup[i])!;\n      const apiResult = response.rows[0].elements[i];\n      if (apiResult.status === 'OK') {\n        distanceInfo.value = apiResult.distance.value;\n        distanceInfo.text = apiResult.distance.text;\n        distanceInfo.source = DistanceSource.DISTANCE_MATRIX;\n      }\n    }\n\n    return destinations.map(destination => distances.get(destination)!);\n  }\n\n  private async getService(): Promise<google.maps.DistanceMatrixService> {\n    if (!DistanceMeasurer.service) {\n      const {DistanceMatrixService} =\n          await APILoader.importLibrary('routes', this.elementForLogging) as\n          google.maps.RoutesLibrary;\n      DistanceMeasurer.service = new DistanceMatrixService();\n    }\n    return DistanceMeasurer.service;\n  }\n\n  /**\n   * Resets Distance Measurer state by deleting any existing service object\n   * and clearing its cache.\n   * This method should be invoked for testing purposes only.\n   * @ignore\n   */\n  static reset() {\n    DistanceMeasurer.cache = makeDistanceMatrixRequestCache();\n    DistanceMeasurer.service = undefined;\n  }\n}\n"]}